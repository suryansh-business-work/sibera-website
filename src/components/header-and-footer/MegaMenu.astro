---
interface Props {
  hasProductHeader?: boolean;
}

const { hasProductHeader = false } = Astro.props;

import { getAppsByCategory } from "../../data/apps-data";
import { getThemeByCategory } from "../../data/app-themes";

const appsByCategory = getAppsByCategory();
const categories = Object.keys(appsByCategory);

// Calculate top position based on whether product header is present
const topPosition = hasProductHeader ? "top-[170px]" : "top-[110px]";
---

<!-- Mega Menu Dialog --><!-- Hover Bridge - invisible area to prevent menu from closing -->
<div
  class={`fixed inset-x-0 ${topPosition} h-3 -translate-y-3 opacity-0 invisible group-hover:opacity-100 group-hover:visible pointer-events-auto z-[99]`}
  aria-hidden="true"
>
</div>

<div
  role="navigation"
  aria-label="Product categories and applications"
  class={`fixed inset-x-0 ${topPosition} bg-white shadow-2xl border-t border-gray-200 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-300 ease-in-out z-[100] mega-menu`}
  style="height: 520px;"
>
  <div class="w-full h-full flex">
    <!-- Sidebar Navigation -->
    <aside
      class="w-72 bg-gray-50/50 border-r border-gray-200 h-full overflow-y-auto py-4 flex-shrink-0"
      aria-label="Product categories"
    >
      <ul class="space-y-1 px-3" role="list">
        {
          categories.map((category, index) => {
            const theme = getThemeByCategory(category);
            return (
              <li>
                <button
                  class={`category-btn w-full text-left px-4 py-3 rounded-r-lg border-l-4 text-sm font-semibold transition-all duration-200 flex items-center justify-between group/btn ${index === 0 ? "" : "border-transparent text-gray-600 hover:bg-gray-100 hover:text-gray-900"}`}
                  style={
                    index === 0
                      ? `background-color: ${theme.backgroundColor}; color: ${theme.primaryColor}; border-left-color: ${theme.primaryColor};`
                      : ""
                  }
                  data-category={category}
                  data-index={index}
                  data-primary-color={theme.primaryColor}
                  data-bg-color={theme.backgroundColor}
                  aria-label={`View ${category} applications`}
                  aria-current={index === 0 ? "true" : "false"}
                  type="button"
                >
                  <span class="flex items-center gap-3">
                    <span
                      class={`w-8 h-8 rounded-md flex items-center justify-center text-xs font-bold border transition-colors duration-200 ${index === 0 ? "bg-white" : "border-gray-200 bg-white text-gray-500 group-hover/btn:border-gray-300 group-hover/btn:text-gray-700"}`}
                      style={
                        index === 0
                          ? `color: ${theme.primaryColor}; border-color: ${theme.primaryColor};`
                          : ""
                      }
                    >
                      {category.substring(0, 2).toUpperCase()}
                    </span>
                    <span>{category}</span>
                  </span>
                  <i
                    class={`fa-solid fa-chevron-right text-xs transition-opacity duration-200 ${index === 0 ? "opacity-100" : "opacity-0 group-hover/btn:opacity-50"}`}
                    aria-hidden="true"
                  />
                </button>
              </li>
            );
          })
        }
      </ul>
    </aside>

    <!-- Content Area -->
    <main
      class="flex-1 h-full overflow-y-auto bg-white px-10 py-8 flex flex-col"
    >
      <div class="flex-1">
        {
          categories.map((category, index) => {
            const apps = appsByCategory[category];
            const theme = getThemeByCategory(category);
            return (
              <div
                id={`category-content-${index}`}
                class={`category-content ${index === 0 ? "block" : "hidden"}`}
                role="region"
                aria-label={`${category} applications`}
              >
                <div class="mb-6 pb-4 border-b border-gray-100">
                  <h2 class="text-2xl font-bold text-gray-900 flex items-center gap-3 mb-2">
                    {category}
                    <span
                      class="px-2.5 py-0.5 rounded-full text-xs font-medium border"
                      style={`background-color: ${theme.backgroundColor}; color: ${theme.primaryColor}; border-color: ${theme.primaryColor}40;`}
                    >
                      {apps.length} {apps.length === 1 ? "App" : "Apps"}
                    </span>
                  </h2>
                  <p class="text-gray-500 text-sm">
                    Explore our suite of {category.toLowerCase()} applications
                    designed to transform your business.
                  </p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                  {apps.map((app) => (
                    <a
                      href={`/app/${app.appSlug || app.appName.toLowerCase().replace(/\s+/g, "-")}`}
                      class="group/card block p-3.5 rounded-xl border border-gray-200 hover:border-blue-500 hover:shadow-md transition-all duration-200 bg-white"
                      aria-label={`Learn more about ${app.appName}`}
                    >
                      <div class="flex items-start gap-3">
                        <div class="flex-shrink-0">
                          <div
                            class="w-10 h-10 rounded-lg flex items-center justify-center p-2 border border-gray-100 bg-gray-50 group-hover/card:bg-white transition-colors"
                            aria-hidden="true"
                          >
                            <img
                              src={app.appLogo}
                              alt=""
                              class="w-full h-full object-contain"
                            />
                          </div>
                        </div>
                        <div class="flex-1 min-w-0">
                          <h3 class="text-sm font-bold text-gray-900 group-hover/card:text-blue-600 mb-0.5 transition-colors">
                            {app.appName}
                          </h3>
                          <p class="text-xs text-gray-500 line-clamp-2 leading-relaxed mb-2">
                            {app.appDescription}
                          </p>
                          <span
                            class={`inline-flex items-center gap-1 px-1.5 py-0.5 rounded text-[10px] font-medium ${app.launchState === "mvp" ? "bg-green-50 text-green-700 border border-green-100" : "bg-amber-50 text-amber-700 border border-amber-100"}`}
                          >
                            <span
                              class={`w-1 h-1 rounded-full ${app.launchState === "mvp" ? "bg-green-500" : "bg-amber-500"}`}
                              aria-hidden="true"
                            />
                            {app.launchState === "mvp"
                              ? "Available"
                              : "Coming Soon"}
                          </span>
                        </div>
                      </div>
                    </a>
                  ))}
                </div>
              </div>
            );
          })
        }
      </div>

      <!-- View All Products Link -->
      <div class="mt-6 pt-4 border-t border-gray-100">
        <a
          href="/all-products"
          class="group inline-flex items-center justify-center gap-2 px-6 py-3 bg-gradient-to-r from-gray-900 to-gray-800 hover:from-blue-600 hover:to-blue-500 text-white text-sm font-bold rounded-xl transition-all duration-300 w-full sm:w-auto shadow-md hover:shadow-blue-500/25 transform hover:-translate-y-0.5"
        >
          <i class="fa-solid fa-grid"></i>
          <span class="text-white">View All Products</span>
          <i
            class="fa-solid fa-arrow-right text-xs group-hover:translate-x-1 transition-transform"
          ></i>
        </a>
      </div>
    </main>
  </div>
</div>

<style>
  /* Custom Scrollbar */
  .overflow-y-auto::-webkit-scrollbar {
    width: 5px;
  }
  .overflow-y-auto::-webkit-scrollbar-track {
    background: transparent;
  }
  .overflow-y-auto::-webkit-scrollbar-thumb {
    background-color: #f1f5f9;
    border-radius: 10px;
  }
  .overflow-y-auto:hover::-webkit-scrollbar-thumb {
    background-color: #cbd5e1;
  }

  /* Focus visible styles */
  .category-btn:focus-visible {
    outline: 2px solid #3b82f6;
    outline-offset: -2px;
  }

  a:focus-visible {
    outline: 2px solid #3b82f6;
    outline-offset: 2px;
  }

  /* Smooth hover delay to prevent accidental close */
  .group:hover .mega-menu,
  .group:hover .mega-menu + div {
    transition-delay: 0ms;
  }

  .mega-menu {
    transition:
      opacity 200ms ease-in-out,
      visibility 200ms ease-in-out;
    transition-delay: 100ms;
  }

  .group:not(:hover) .mega-menu {
    transition-delay: 150ms;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(5px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .animate-fadeIn {
    animation: fadeIn 0.3s ease-out forwards;
  }
</style>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const buttons: any = document.querySelectorAll("[data-category]");
    const contents = document.querySelectorAll(".category-content");
    const megaMenu = document.querySelector(".mega-menu") as HTMLElement;

    // Initialize first category color if needed
    if (buttons.length > 0 && megaMenu) {
      const firstBtn = buttons[0];
      const primaryColor = firstBtn.getAttribute("data-primary-color");
      if (primaryColor) {
        megaMenu.style.borderTopColor = primaryColor;
      }
    }

    function switchCategory(index: number) {
      // Reset all buttons
      buttons.forEach((btn: any, i: any) => {
        const isActive = i === index;
        const primaryColor = btn.getAttribute("data-primary-color");
        const bgColor = btn.getAttribute("data-bg-color");

        if (isActive) {
          btn.classList.remove(
            "border-transparent",
            "text-gray-600",
            "hover:bg-gray-100",
            "hover:text-gray-900",
          );
          // Apply active styles via inline styles for dynamic colors
          btn.style.backgroundColor = bgColor;
          btn.style.color = primaryColor;
          btn.style.borderLeftColor = primaryColor;

          // Update mega menu top border
          if (megaMenu) {
            megaMenu.style.borderTopColor = primaryColor;
          }
        } else {
          // Reset styles
          btn.style.backgroundColor = "";
          btn.style.color = "";
          btn.style.borderLeftColor = "";

          btn.classList.add(
            "border-transparent",
            "text-gray-600",
            "hover:bg-gray-100",
            "hover:text-gray-900",
          );
        }

        btn.setAttribute("aria-current", isActive ? "true" : "false");

        const icon = btn.querySelector("i");
        const badge = btn.querySelector("span > span");

        if (icon) {
          icon.classList.toggle("opacity-100", isActive);
          // Handle opacity for inactive state via class logic in HTML, but ensure it's reset here if needed
          if (!isActive) {
            icon.classList.remove("opacity-100");
            // The class list in HTML handles the hover opacity
          }
        }

        if (badge) {
          if (isActive) {
            badge.classList.remove(
              "border-gray-200",
              "bg-white",
              "text-gray-500",
              "group-hover/btn:border-gray-300",
              "group-hover/btn:text-gray-700",
            );
            badge.classList.add("bg-white");
            badge.style.color = primaryColor;
            badge.style.borderColor = primaryColor;
          } else {
            badge.classList.remove("bg-white");
            badge.classList.add(
              "border-gray-200",
              "bg-white",
              "text-gray-500",
              "group-hover/btn:border-gray-300",
              "group-hover/btn:text-gray-700",
            );
            badge.style.color = "";
            badge.style.borderColor = "";
          }
        }
      });

      // Show appropriate content
      contents.forEach((content, i) => {
        if (i === index) {
          content.classList.remove("hidden");
          content.classList.add("block", "animate-fadeIn");
        } else {
          content.classList.add("hidden");
          content.classList.remove("block", "animate-fadeIn");
        }
      });
    }

    // Add event listeners
    buttons.forEach((button: any, idx: any) => {
      button.addEventListener("click", () => switchCategory(idx));
      button.addEventListener("mouseenter", () => switchCategory(idx));

      button.addEventListener("keydown", (e: KeyboardEvent) => {
        if (e.key === "ArrowDown") {
          e.preventDefault();
          const nextIndex = (idx + 1) % buttons.length;
          (buttons[nextIndex] as HTMLElement).focus();
          switchCategory(nextIndex);
        } else if (e.key === "ArrowUp") {
          e.preventDefault();
          const prevIndex = (idx - 1 + buttons.length) % buttons.length;
          (buttons[prevIndex] as HTMLElement).focus();
          switchCategory(prevIndex);
        }
      });
    });

    // Close on Escape key
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        const megaMenu = document.querySelector(".mega-menu");
        const productsButton = document.querySelector(
          '[aria-haspopup="dialog"]',
        ) as HTMLElement;

        if (megaMenu && !megaMenu.classList.contains("invisible")) {
          const parentGroup = megaMenu.closest(".group");
          if (parentGroup) {
            parentGroup.dispatchEvent(new MouseEvent("mouseleave"));
            productsButton?.focus();
          }
        }
      }
    });
  });
</script>
